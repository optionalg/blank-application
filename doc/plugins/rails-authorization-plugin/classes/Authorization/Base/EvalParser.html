<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: Authorization::Base::EvalParser</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">Authorization::Base::EvalParser</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/vendor/plugins/rails-authorization-plugin/lib/publishare/parser_rb.html">
                vendor/plugins/rails-authorization-plugin/lib/publishare/parser.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000024">parse_authorization_expression</a>&nbsp;&nbsp;
      <a href="#M000029">process_role</a>&nbsp;&nbsp;
      <a href="#M000028">process_role_of_model</a>&nbsp;&nbsp;
      <a href="#M000026">replace_role</a>&nbsp;&nbsp;
      <a href="#M000027">replace_role_of_model</a>&nbsp;&nbsp;
      <a href="#M000025">replace_temporarily_role_of_model</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000024" class="method-detail">
        <a name="M000024"></a>

        <div class="method-heading">
          <a href="#M000024" class="method-signature">
          <span class="method-name">parse_authorization_expression</span><span class="method-args">( str )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Parses and evaluates an authorization expression and returns <tt>true</tt>
or <tt>false</tt>.
</p>
<p>
The authorization expression is defined by the following grammar:
</p>
<pre>
        &lt;expr&gt; ::= (&lt;expr&gt;) | not &lt;expr&gt; | &lt;term&gt; or &lt;expr&gt; | &lt;term&gt; and &lt;expr&gt; | &lt;term&gt;
        &lt;term&gt; ::= &lt;role&gt; | &lt;role&gt; &lt;preposition&gt; &lt;model&gt;
 &lt;preposition&gt; ::= of | for | in | on | to | at | by
       &lt;model&gt; ::= /:*\w+/
        &lt;role&gt; ::= /\w+/ | /'.*'/
</pre>
<p>
Instead of doing recursive descent parsing (not so fun when we support
nested parentheses, etc), we let Ruby do the work for us by inserting the
appropriate permission calls and using eval. This would not be a good idea
if you were getting authorization expressions from the outside, so in that
case (e.g. somehow letting users literally type in permission expressions)
you&#8216;d be better off using the recursive descent parser in Module <a
href="RecursiveDescentParser.html">RecursiveDescentParser</a>.
</p>
<p>
We search for parts of our authorization evaluation that match &lt;role&gt;
or &lt;role&gt; &lt;preposition&gt; &lt;model&gt; and we ignore anything
terminal in our grammar.
</p>
<p>
1) Replace all &lt;role&gt; &lt;preposition&gt; &lt;model&gt; matches. 2)
Replace all &lt;role&gt; matches that aren&#8216;t one of our other
terminals (&#8216;not&#8217;, &#8216;or&#8217;, &#8216;and&#8217;, or
preposition) 3) Eval
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000024-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000024-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/rails-authorization-plugin/lib/publishare/parser.rb, line 31</span>
31:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_authorization_expression</span>( <span class="ruby-identifier">str</span> )
32:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">str</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/[^A-Za-z0-9_:'\(\)\s]/</span>
33:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">AuthorizationExpressionInvalid</span>, <span class="ruby-node">&quot;Invalid authorization expression (#{str})&quot;</span>
34:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
35:         <span class="ruby-keyword kw">end</span>
36:         <span class="ruby-ivar">@replacements</span> = []
37:         <span class="ruby-identifier">expr</span> = <span class="ruby-identifier">replace_temporarily_role_of_model</span>( <span class="ruby-identifier">str</span> )
38:         <span class="ruby-identifier">expr</span> = <span class="ruby-identifier">replace_role</span>( <span class="ruby-identifier">expr</span> )
39:         <span class="ruby-identifier">expr</span> = <span class="ruby-identifier">replace_role_of_model</span>( <span class="ruby-identifier">expr</span> )
40:         <span class="ruby-keyword kw">begin</span>
41:           <span class="ruby-identifier">instance_eval</span>( <span class="ruby-identifier">expr</span> )
42:         <span class="ruby-keyword kw">rescue</span>
43:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">AuthorizationExpressionInvalid</span>, <span class="ruby-node">&quot;Cannot parse authorization (#{str})&quot;</span>
44:         <span class="ruby-keyword kw">end</span>
45:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000029" class="method-detail">
        <a name="M000029"></a>

        <div class="method-heading">
          <a href="#M000029" class="method-signature">
          <span class="method-name">process_role</span><span class="method-args">( role_name )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000029-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000029-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/rails-authorization-plugin/lib/publishare/parser.rb, line 81</span>
81:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_role</span>( <span class="ruby-identifier">role_name</span> )
82:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@current_user</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:false</span>
83:         <span class="ruby-identifier">raise</span>( <span class="ruby-constant">UserDoesntImplementRoles</span>, <span class="ruby-value str">&quot;User doesn't implement #has_role?&quot;</span> ) <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-identifier">:has_role?</span>
84:         <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">has_role?</span>( <span class="ruby-identifier">role_name</span> )
85:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000028" class="method-detail">
        <a name="M000028"></a>

        <div class="method-heading">
          <a href="#M000028" class="method-signature">
          <span class="method-name">process_role_of_model</span><span class="method-args">( role_name, model_name )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000028-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000028-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/rails-authorization-plugin/lib/publishare/parser.rb, line 75</span>
75:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_role_of_model</span>( <span class="ruby-identifier">role_name</span>, <span class="ruby-identifier">model_name</span> )
76:         <span class="ruby-identifier">model</span> = <span class="ruby-identifier">get_model</span>( <span class="ruby-identifier">model_name</span> )
77:         <span class="ruby-identifier">raise</span>( <span class="ruby-constant">ModelDoesntImplementRoles</span>, <span class="ruby-node">&quot;Model (#{model_name}) doesn't implement #accepts_role?&quot;</span> ) <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-identifier">:accepts_role?</span>
78:         <span class="ruby-identifier">model</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">:accepts_role?</span>, <span class="ruby-identifier">role_name</span>, <span class="ruby-ivar">@current_user</span> )
79:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000026" class="method-detail">
        <a name="M000026"></a>

        <div class="method-heading">
          <a href="#M000026" class="method-signature">
          <span class="method-name">replace_role</span><span class="method-args">( str )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000026-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000026-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/rails-authorization-plugin/lib/publishare/parser.rb, line 57</span>
57:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">replace_role</span>( <span class="ruby-identifier">str</span> )
58:         <span class="ruby-identifier">role_regex</span> = <span class="ruby-value str">'\s*(\'\s*(.+?)\s*\'|([A-Za-z]\w*))\s*'</span>
59:         <span class="ruby-identifier">parse_regex</span> = <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">role_regex</span>)
60:         <span class="ruby-identifier">str</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-identifier">parse_regex</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">match</span><span class="ruby-operator">|</span>
61:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">BOOLEAN_OPS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">$3</span>)
62:             <span class="ruby-node">&quot; #{match} &quot;</span>
63:           <span class="ruby-keyword kw">else</span>
64:             <span class="ruby-node">&quot; process_role('#{$2 || $3}') &quot;</span>
65:           <span class="ruby-keyword kw">end</span>
66:         <span class="ruby-keyword kw">end</span>
67:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000027" class="method-detail">
        <a name="M000027"></a>

        <div class="method-heading">
          <a href="#M000027" class="method-signature">
          <span class="method-name">replace_role_of_model</span><span class="method-args">( str )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000027-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000027-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/rails-authorization-plugin/lib/publishare/parser.rb, line 69</span>
69:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">replace_role_of_model</span>( <span class="ruby-identifier">str</span> )
70:         <span class="ruby-identifier">str</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;(\d+)&gt;/</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">match</span><span class="ruby-operator">|</span>
71:           <span class="ruby-ivar">@replacements</span>[<span class="ruby-identifier">$1</span>.<span class="ruby-identifier">to_i</span>]
72:         <span class="ruby-keyword kw">end</span>
73:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000025" class="method-detail">
        <a name="M000025"></a>

        <div class="method-heading">
          <a href="#M000025" class="method-signature">
          <span class="method-name">replace_temporarily_role_of_model</span><span class="method-args">( str )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000025-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000025-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/rails-authorization-plugin/lib/publishare/parser.rb, line 47</span>
47:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">replace_temporarily_role_of_model</span>( <span class="ruby-identifier">str</span> )
48:         <span class="ruby-identifier">role_regex</span> = <span class="ruby-value str">'\s*(\'\s*(.+?)\s*\'|(\w+))\s+'</span>
49:         <span class="ruby-identifier">model_regex</span> = <span class="ruby-value str">'\s+(:*\w+)'</span>
50:         <span class="ruby-identifier">parse_regex</span> = <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">role_regex</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'('</span> <span class="ruby-operator">+</span> <span class="ruby-constant">VALID_PREPOSITIONS</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">'|'</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">')'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">model_regex</span>)
51:         <span class="ruby-identifier">str</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-identifier">parse_regex</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">match</span><span class="ruby-operator">|</span>
52:           <span class="ruby-ivar">@replacements</span>.<span class="ruby-identifier">push</span> <span class="ruby-node">&quot; process_role_of_model('#{$2 || $3}', '#{$5}') &quot;</span>
53:           <span class="ruby-node">&quot; &lt;#{@replacements.length-1}&gt; &quot;</span>
54:         <span class="ruby-keyword kw">end</span>
55:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>