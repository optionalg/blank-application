<% item_class_name = item.class.to_s.underscore %>
<% res=[]
  get_sa_config['sa_item_categories'].each do |cat|
  res = res + Workspace.allowed_user_with_permission(@current_user.id, "item_cat_"+cat+"_new")
end %>
<% list = (res + Workspace.allowed_user_with_permission(@current_user.id, item_class_name+"_new")).uniq
  p '================================================'
  p list
%>
<%=	check_box_tag_name = "#{item_class_name}[associated_workspaces][]"
# Checkboxes for associated WorkSpaces
  (list.delete_if{ |w| !w.ws_items.to_s.split(',').include?(item_class_name) }.collect do |w|
	checked = Item.exists?(:workspace_id => w.id, :itemable_id => item.id, :itemable_type => item.class.to_s)
    # Out
    if ((w.state == 'private') && (w.creator_id == @current_user.id) && (item.new_record? || item.user_id==@current_user.id)) || (list.size==1)
      check_box_tag(check_box_tag_name, w.id, true, :disabled => true, :class => 'checkBoxElement') + ' ' + w.title + hidden_field_tag(check_box_tag_name, w.id.to_s)
    else
      check_box_tag(check_box_tag_name, w.id, checked, :class => 'checkBoxElement') + ' ' + w.title
    end
  end).join('<br />')
%>
<% (item.workspaces - list).each do |ws| %>
  <%= hidden_field_tag(check_box_tag_name, ws.id.to_s) %>
<% end %>