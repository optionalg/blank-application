<% item_class_name = item.class.to_s.underscore
check_box_tag_name = "#{item_class_name}[associated_workspaces][]"
res=[]
@configuration['sa_item_categories'].each do |cat|
  res = res + Workspace.allowed_user_with_permission(@current_user.id, "item_cat_"+cat+"_new")
end
list = (res + Workspace.allowed_user_with_permission(@current_user.id, item_class_name+"_new")).uniq
list2 = list.delete_if{ |w| !w.ws_items.to_s.split(',').include?(item_class_name) }
%>
<% if (list2.size > 0)
  f.field :workspaces, :label => I18n.t('general.object.workspace').camelize+'(s) :' do %>
     <%= (list2.collect do |w|
         if params[item.class.to_s.downcase] && params[item.class.to_s.downcase][:associated_workspaces]
            checked = params[item.class.to_s.downcase][:associated_workspaces].include?(w.id.to_s)
         else
            checked = Item.exists?(:workspace_id => w.id, :itemable_id => item.id, :itemable_type => item.class.to_s)
         end
        
        # Out
        if ((w.state == 'private') && (w.creator_id == @current_user.id) && (item.new_record? || item.user_id==@current_user.id)) || (list.size==1) || (w == current_workspace)
          check_box_tag(check_box_tag_name, w.id, true, :disabled => true, :class => 'checkboxes') + ' ' + w.title + hidden_field_tag(check_box_tag_name, w.id.to_s)
        else
          check_box_tag(check_box_tag_name, w.id, checked, :class => 'checkboxes') + ' ' + w.title
        end
      end).join('<br />')
    %>
  <% end %>
<% end %>
<% (item.workspaces - list).each do |ws| %>
  <%= hidden_field_tag(check_box_tag_name, ws.id.to_s) %>
<% end %>
